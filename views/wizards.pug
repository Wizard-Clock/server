extends layout

block content
    div(class="row justify-content-center")
        div(class="col-auto w-75")
            div()
                h1(class="pb-2 mb-4 border-bottom") Wizard Management
                table(class="table table-striped table-hover")
                    thead()
                        tr()
                            th(scope="col") ID
                            th(scope="col") Username
                            th(scope="col") Role
                            th(scope="col") Edit
                            th(scope="col") Delete
                    tbody()
                        each wizard in wizards
                            tr()
                                th(scope="row" id="wizardID")= wizard.id
                                td()= wizard.username
                                td()= wizard.role
                                td()
                                    button(type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#editModal" data-bs-wizard= wizard)
                                        i(class="bi bi-pencil-square")
                                if wizard.id === 1
                                    td() Cannot Delete
                                else
                                    td()
                                        button(type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-bs-wizard-id= wizard.id data-bs-wizard-name= wizard.username)
                                            i(class="bi bi-trash3-fill")
                button(type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal") Add User&nbsp;
                    i(class="bi bi-person-plus-fill")

            div(class="modal fade" id="deleteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true")
                div(class="modal-dialog modal-dialog-centered")
                    div(class="modal-content")
                        div(class="modal-header")
                            h1(class="modal-title fs-5" id="deleteModalLabel") Confirm Delete User
                            button(type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close")
                        div(class="modal-body")
                            p() Are you sure you want to delete this user?
                            p(class="wizard_username")
                            p(class="wizard_id")
                        div(class="modal-footer")
                            button(type="button" class="btn btn-secondary" data-bs-dismiss="modal") Cancel
                            button(type="button" class="btn btn-primary" onclick="deleteUserAction()") Delete

            div(class="modal fade" id="editModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true")
                div(class="modal-dialog modal-dialog-centered")
                    div(class="modal-content")
                        div(class="modal-header")
                            h1(class="modal-title fs-5" id="editModalLabel") Edit User
                            button(type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close")
                        div(class="modal-body")
                            form(class="row g-3" id="editUserForm")
                                div(class="col-md-2")
                                    section()
                                        label(for="userId" class="form-label") ID
                                        input(type="text" class="form-control user-id" name="userid" id='userid' disabled)
                                div(class="col-md-6")
                                    section()
                                        label(for="usernameEdit" class="form-label") Username
                                        input(type="text" class="form-control username" name="username" id="usernameEdit")
                                div(class="col-md-4")
                                    section()
                                        label(for="roleEdit" class="form-label") Role
                                        select(id="roleEdit" class="form-select role-select" name="role")
                                            option(selected disabled value="") Choose...
                                            for role in roles
                                                option(value= role.role)=role.role
                                div(class="col-md-6")
                                    section()
                                        label(for="passwordEdit" class="form-label") Password
                                        input(type="text" class="form-control" name="password" id="passwordEdit")
                                div(class="col-md-6")
                                    section()
                                        label(for="passwordEditConfirm" class="form-label") Confirm Password
                                        input(type="password" class="form-control" id="passwordEditConfirm")
                        div(class="modal-footer")
                            button(type="button" class="btn btn-secondary" data-bs-dismiss="modal") Cancel
                            button(type="button" class="btn btn-primary" onclick="editUserAction()") Apply Changes

            div(class="modal fade" id="addUserModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true")
                div(class="modal-dialog modal-dialog-centered")
                    div(class="modal-content")
                        div(class="modal-header")
                            h1(class="modal-title fs-5" id="addUserModalLabel") Add User
                            button(type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close")
                        div(class="modal-body")
                            form(class="row g-3" id="addUserForm")
                                div(class="col-md-6")
                                    section()
                                        label(for="usernameAddInput" class="form-label") Username
                                        input(type="text" class="form-control" name="username" id="usernameAddInput" required)
                                div(class="col-md-6")
                                    section()
                                        label(for="roleAddInput" class="form-label") Role
                                        select(id="roleAddInput" class="form-select" name="role" required)
                                            option(selected disabled value="") Choose...
                                            for role in roles
                                                option()=role.role
                                div(class="col-md-6")
                                    section()
                                        label(for="passwordAddPlain" class="form-label") Password
                                        input(type="text" class="form-control" name="password" id="passwordAddPlain" required)
                                div(class="col-md-6")
                                    section()
                                        label(for="passwordAddFinal" class="form-label") Confirm Password
                                        input(type="password" class="form-control" id="passwordAddFinal" required)
                                div(class="col-12")
                                    button(type="submit" class="btn btn-primary") Add User
                        div(class="modal-footer")
                            button(type="button" class="btn btn-secondary" data-bs-dismiss="modal") Cancel

            script.
                let deleteModal = document.getElementById('deleteModal');
                if (deleteModal) {
                    deleteModal.addEventListener('show.bs.modal', event => {
                        const button = event.relatedTarget;

                        const wizName = button.getAttribute('data-bs-wizard-name');
                        const modalBodyUsername = deleteModal.querySelector('.wizard_username');
                        modalBodyUsername.textContent = `Username: ${wizName}`;

                        const wizID = button.getAttribute('data-bs-wizard-id');
                        const modalBodyID = deleteModal.querySelector('.wizard_id');
                        modalBodyID.textContent = `ID: ${wizID}`;
                    });
                }

                async function deleteUserAction() {
                    let deleteModal = document.getElementById('deleteModal');
                    if (deleteModal) {
                        let idString = document.getElementById('deleteModal').querySelector('.wizard_id').textContent;
                        idString = idString.slice(3).trim();
                        let response = await fetch('/wizards/deleteUser', {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({id: idString})
                        });
                        let result = await response.json();
                        if (result.success) {
                            $('#deleteModal').modal('hide');
                            window.location.reload();
                        } else {
                            alert("Deletion Error");
                        }
                    }
                }

                let editModal = document.getElementById('editModal');
                if (editModal) {
                    editModal.addEventListener('show.bs.modal', event => {
                        const button = event.relatedTarget;

                        const wiz = JSON.parse(button.getAttribute('data-bs-wizard'));

                        editModal.querySelector('.user-id').value = wiz.id;
                        editModal.querySelector('.username').value = wiz.username;
                        editModal.querySelector('.role-select').value = wiz.role;
                    });
                }

                async function editUserAction() {
                    let editModal = document.getElementById('editModal');
                    if (editModal) {
                        let pass = document.getElementById('passwordEdit').value;
                        if (pass !== "") {
                            let passConf = document.getElementById('passwordEditConfirm').value;
                            if (pass !== passConf) {
                                alert("Passwords must match.");
                                return;
                            }
                        }
                        let response = await fetch('/wizards/updateUser', {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                id: document.getElementById('userid').value,
                                username: document.getElementById('usernameEdit').value,
                                role: document.getElementById('roleEdit').value,
                                password: pass

                            })
                        });
                        let result = await response.json();
                        if (result.success) {
                            $('#editModal').modal('hide');
                            window.location.reload();
                        } else {
                            alert("Edit Error");
                        }
                    }
                }

                let addUserForm = document.getElementById('addUserForm');
                addUserForm.onsubmit = async (e) => {
                    e.preventDefault();
                    let firstPass = document.getElementById('passwordAddPlain').value;
                    let secPass = document.getElementById('passwordAddFinal').value;
                    if (firstPass === secPass) {
                        let response = await fetch('/wizards/addUser', {
                            method: 'POST',
                            body: new FormData(addUserForm)
                        });
                        let result = await response.json();
                        if (result.success) {
                            addUserForm.reset();
                            window.location.reload();
                        } else {
                            alert("Submission Error");
                        }
                    } else {
                        alert("Passwords much match.");
                    }
                }
